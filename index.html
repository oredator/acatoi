<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendario con Opciones</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
/* Centrar completamente el calendario en la pantalla */
html, body {
    font-family: Arial, sans-serif;
    height: 100%;
    margin: 0;
    padding: 0;
    justify-content: center;
    align-items: flex-start;
    background-color: #dbdbdb;
    overflow: auto;
}




/* Ajustar el tamaño del contenedor del calendario */
.calendar-container {
    width: 90vw; /* Aumenta el ancho del calendario */
    max-width: 1450px; /* Asegura que no se agrande demasiado */
    min-height: fit-content;
    background: #f0f0f0;
    padding: 20px;
    border-radius: 10px;
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    text-align: center;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    margin: auto;
}


/* Mantener el header del calendario centrado */
.calendar-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
    top: 0;
    background: #dadada;
    z-index: 10;
    padding: 10px 0;
    border-radius: 10px;
}


.calendar-header button {
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
}

.calendar-header button:hover {
    color: blue;
}

/* Asegurar que los nombres de los días y los días del calendario tengan la misma estructura */
.days-of-week {
    display: grid;
    grid-template-columns: repeat(7, minmax(80px, 1fr));
    font-weight: bold;
    text-align: center;
    width: 100%;
}


/* Asegurar que el contenedor de los días coincida en tamaño con los nombres */
.calendar-days {
    display: flex;
    flex-direction: column;
    gap: 10px;
    align-items: center;
    width: 100%;
}

/* Asegurar que cada semana se alinee correctamente */
.week-container {
    display: grid;
    grid-template-columns: repeat(7, minmax(80px, 1fr));
    gap: 5px;
    width: 100%;
}



/* Día del calendario */
.day {
    width: 100%;
    aspect-ratio: 1 / 1.2;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
    background: #fdcd66;
    border-radius: 5px;
    font-size: 0.8rem;
    padding: 4px;
    box-sizing: border-box;
    min-width: 0; /* 💡 importante para que no "resista" reducirse */
}



/* Día actual */
.day.today {
    background: #ff58338f !important;
    color: rgb(54, 54, 54);
    font-weight: bold;
}

/* Colores según el total del día */
.day.positive {
    background: #c8f7c5; /* Verde claro */
}

.day.negative {
    background: #ff9191; /* Rojo claro */
}

.day.neutral {
    background: #ddd; /* Gris */
}

/* Estilos para la suma semanal */
.week-total {
    width: 140px; /* Coincide con el ancho de cada celda */
    min-height: 170px; /* Coincide con la altura de cada celda */
    font-size: 16px;
    font-weight: bold;
    background: #fff;
    border: 2px solid #000;
    padding: 10px;
    text-align: center;
    border-radius: 5px;
    display: flex;
    align-items: center;
    justify-content: center;
}


/* Espaciado entre semanas */
.week-container + .week-container {
    margin-top: 10px;
}

/* Estilos para select e input */
.day select,
.day input[type="number"] {
    width: 90%;
    font-size: 0.7rem;
    margin-top: 3px;
    padding: 5px;
    border-radius: 5px;
    border: 1px solid #ccc;
    background: white;
    text-align: center;
}


/* Resaltar cuando el input está en uso */
.day input[type="number"]:focus {
    outline: 1px solid #222222;
    border-color: #3498db;
}

/* Botón "Nuevo" */
.new-button {
    width: 60px;
    font-size: 12px;
    padding: 3px;
    margin-top: 5px;
    cursor: pointer;
    border: none;
    background-color: #3498db;
    color: white;
    border-radius: 5px;
}

.new-button:hover {
    background-color: #2980b9;
}

/* Contenedor de selects y inputs */
.select-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    margin-top: 5px;
    gap: 5px;
}

/* Botón de imagen */
.image-button {
    background-color: #2ecc71;
    color: white;
    border: none;
    padding: 5px;
    border-radius: 5px;
    cursor: pointer;
    margin-top: 5px;
    font-size: 12px;
}

.image-button:hover {
    background-color: #27ae60;
}

/* Previsualización de imagen */
.image-preview {
    width: 50px;
    height: 50px;
    object-fit: cover;
    border-radius: 5px;
    cursor: pointer;
    margin-top: 5px;
    border: 1px solid #ccc;
}

/* Estilos para el modal */
.image-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    display: flex;
    justify-content: center;
    align-items: center;
}

.modal-content {
    position: relative;
    background: white;
    padding: 20px;
    border-radius: 10px;
    text-align: center;
}

.modal-image {
    width: 100%;
    height: auto;
    max-height: 70vh; /* Limitar la altura de la imagen */
    border-radius: 10px;
}

.close-modal {
    position: absolute;
    top: 10px;
    right: 15px;
    font-size: 24px;
    cursor: pointer;
}

/* Colores según el total del día */
.day.positive {
    background: #c8f7c5; /* Verde claro */
}

.day.negative {
    background: #f7c5c5; /* Rojo claro */
}

.day.neutral {
    background: #ddd; /* Gris */
}

/* Estilos para la suma semanal */
.week-total {
    width: 140px; /* Coincide con el ancho de cada celda */
    min-height: 170px; /* Coincide con la altura de cada celda */
    font-size: 16px;
    font-weight: bold;
    background: #fff;
    border: 2px solid #7e7e7e;
    padding: 10px;
    text-align: center;
    border-radius: 5px;
    display: flex;
    align-items: center;
    justify-content: center;
}


/* Espaciado entre semanas */
.week-container + .week-container {
    margin-top: 10px;
}
/* Ocultar el header cuando se abra una imagen */
.hide-header .calendar-header {
    display: none;
}

/* Estilos para el resultado semanal */
.positive-week {
    background: #c8f7c5 !important; /* Verde claro */
    border: 2px solid #27ae60;
}

.negative-week {
    background: #f7c5c5 !important; /* Rojo claro */
    border: 2px solid #c0392b;
}

.neutral-week {
    background: #ddd !important; /* Gris */
    border: 2px solid #aaa;
}

/*Estilos apra el contenedor de cuenta*/
.account-size-container {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    background-color: #efffda; /* Color de fondo suave */
    padding: 10px;
    border-radius: 8px;
    margin: 10px auto;
    width: fit-content;
    box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.1);
}

.account-size-container label {
    font-size: 16px;
    font-weight: bold;
    color: #000000;
}

#account-size {
    padding: 8px;
    font-size: 16px;
    width: 120px;
    border: 1px solid #ccc;
    border-radius: 5px;
    transition: all 0.3s ease;
    text-align: center;
    color: #000000;
    font-weight: bold;
}

#account-size:focus {
    border-color: #007bff;
    box-shadow: 0px 0px 5px rgba(0, 123, 255, 0.5);
    outline: none;
}
/*Estilos apra el contenedor de suma total mes*/

.account-summary {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 20px;
    margin-bottom: 15px;
}

.monthly-total-container {
    font-size: 18px;
    font-weight: bold;
    background-color: #efffda;
    padding: 8px 15px;
    border-radius: 8px;
    box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.1);
}

/*Porcentaje*/
.monthly-percentage-container {
    font-size: 16px;
    font-weight: bold;
    margin-top: 5px;
    text-align: center;
    background-color: #f8f9fa;
    padding: 5px 10px;
    border-radius: 6px;
    box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.1);
}

/*botonmes de compra y evnta*/
.button-container {
    display: flex;
    gap: 5px;
    justify-content: center;
    width: 100%;
}

.buy-button, .sell-button {
    font-size: 12px;
    padding: 6px 12px;
    width: 50%;
    border: 1px solid #ccc;
    border-radius: 5px;
    cursor: pointer;
    transition: all 0.3s ease;
    background-color: #f8f9fa;
    color: #333;
}

.buy-button:hover, .sell-button:hover {
    background-color: #e0e0e0;
}

/* Cuando se selecciona "Compra" */
.buy-button.selected {
    background-color: #7dee75 !important; /* Verde claro */
    color: #1b5e20 !important; /* Verde oscuro para mejor contraste */
    border-color: #1b5e20;
}

/* Cuando se selecciona "Venta" */
.sell-button.selected {
    background-color: #fd9797 !important; /* Rojo claro */
    color: #b71c1c !important; /* Rojo oscuro para mejor contraste */
    border-color: #b71c1c;
}




/*estilos total mes y cuenta*/
.total-balance-container {
    font-size: 16px;
    font-weight: bold;
    background-color: #f8f9fa;
    padding: 8px 12px;
    border-radius: 8px;
    margin-left: 15px;
    box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.1);
}


/*botones de tp sl y be*/
.trade-type-container {
    display: flex;
    gap: 5px;
    justify-content: center;
    margin-top: 5px;
}

.tp-button, .sl-button, .be-button {
    font-size: 11px;
    padding: 3px 8px;
    border: 1px solid #ccc;
    border-radius: 4px;
    cursor: pointer;
    background-color: #f1f1f1;
    transition: background-color 0.3s ease;
}

.tp-button:hover, .sl-button:hover, .be-button:hover {
    background-color: #ddd;
}

/* Colores al estar seleccionados */
.tp-button.selected {
    background-color: #a5d6a7; /* Verde suave */
    color: #1b5e20;
    border-color: #1b5e20;
}

.sl-button.selected {
    background-color: #ef9a9a; /* Rojo suave */
    color: #b71c1c;
    border-color: #b71c1c;
}

.be-button.selected {
    background-color: #90caf9; /* Azul suave */
    color: #0d47a1;
    border-color: #0d47a1;
}




/*Estilos modal de estadisitcias*/
/* Estilos del Modal */
.modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    display: flex;
    justify-content: center;
    align-items: center;
}

.modal-content {
    position: relative;
    background: rgb(219, 219, 219);
    padding: 20px;
    border-radius: 10px;
    text-align: center;
    width: 80%; /* Cambiar el ancho para agrandar el modal */
    max-width: 1000px; /* Limitar el ancho máximo */
    height: auto; /* Asegura que el modal se ajuste al contenido */
    max-height: 80vh; /* Limitar la altura máxima */
}

.close-modal {
    position: absolute;
    top: 10px;
    right: 10px;
    font-size: 24px;
    cursor: pointer;
}






.small-btn {
    padding: 2px 6px;
    font-size: 12px;
    background-color: #eee;
    color: #333;
    border: 1px solid #ccc;
    border-radius: 4px;
    cursor: pointer;
}

.small-btn:hover {
    background-color: #a1a1a1;
}
.details-button {
    background-color: #4caf50;
    color: white;
    padding: 10px 18px;
    font-size: 14px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 2px 2px 6px rgba(0, 0, 0, 0.1);
}

.details-button:hover {
    background-color: #388e3c;
    transform: scale(1.03);
}


/*cantidad del modal de ver detalles*/
.summary-boxes {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 12px;
    margin: 20px 0;
}

.summary-item {
    padding: 12px 16px;
    border-radius: 8px;
    font-weight: bold;
    color: #333;
    min-width: 100px;
    text-align: center;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    transition: transform 0.2s ease;
}

.summary-item:hover {
    transform: translateY(-3px);
}

/* 🎯 Colores personalizados */
.summary-item.tp,
.summary-item.compra {
    background-color: #d4f8d4; /* Verde claro */
    border: 1px solid #2e7d32;
}

.summary-item.sl,
.summary-item.venta {
    background-color: #f8d4d4; /* Rojo claro */
    border: 1px solid #c62828;
}

.summary-item.be {
    background-color: #d4e7f8; /* Azul claro */
    border: 1px solid #1565c0;
}



/*boton indicador en que calendario esta*/
/* Estilo base de los botones */
/* Base de todos los botones */
.calendar-btn {
    background-color: #f1f1f1;
    color: #333;
    border: 1px solid #ccc;
    padding: 8px 12px;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.2s ease;
    box-shadow: none;
}

/* Hover para todos los botones */
.calendar-btn:hover {
    background-color: #e0e0e0;
    box-shadow: 0 3px 8px rgba(0, 0, 0, 0.15);
    transform: translateY(-2px);
}

/* Estilo del calendario activo */
.calendar-btn.active {
    background-color: #aaaaaa !important;
    color: rgb(94, 94, 94) !important;
    font-weight: bold;
    border: 1px solid #000000 !important;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
    transform: translateY(-2px);
}

/*Estilos modal de comentarios*/
.modal {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.7);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 999;
}

.modal-content {
    background: white;
    padding: 20px;
    border-radius: 10px;
    width: 90%;
    max-width: 500px;
    position: relative;
}

.close-modal {
    position: absolute;
    top: 10px; right: 15px;
    font-size: 24px;
    cursor: pointer;
}




    </style>
</head>
<body>
<main>    
    
<div class="calendar-container">
    <div class="calendar-header">
        <button onclick="changeMonth(-1)">⬅</button>
        <h2 id="month-year"></h2>
        <button onclick="changeMonth(1)">➡</button>
    </div>
<div style="text-align: center; margin: 10px 0;">
    <button id="open-rewards" class="details-button">🎁 Premios</button>
</div>

    
    
    <div class="days-of-week">
        <div>Lun</div><div>Mar</div><div>Mié</div><div>Jue</div><div>Vie</div><div>Sáb</div><div>Dom</div>
    </div>


    <div class="calendar-days" id="calendar-days"></div>
</div>

<script>
// 🗃️ IndexedDB - base para imágenes
const dbName = "CalendarioImagenesDB";
const storeName = "imagenes";

// Abrir o crear la base de datos
function openDB() {
    return new Promise((resolve, reject) => {
        const request = indexedDB.open(dbName, 1);
        request.onerror = (e) => reject(e);
        request.onsuccess = (e) => resolve(e.target.result);
        request.onupgradeneeded = (e) => {
            const db = e.target.result;
            db.createObjectStore(storeName);
        };
    });
}

// Guardar imagen como blob base64 (ID = img-UNIQUEID)
async function saveImageToDB(id, base64) {
    const db = await openDB();
    const tx = db.transaction(storeName, "readwrite");
    tx.objectStore(storeName).put(base64, id);
    return tx.complete;
}

// Obtener imagen por ID
function loadImageFromDB(id) {
    return new Promise(async (resolve, reject) => {
        const db = await openDB();
        const tx = db.transaction("imagenes", "readonly");
        const store = tx.objectStore("imagenes");
        const req = store.get(id);
        req.onsuccess = () => resolve(req.result);
        req.onerror = () => reject(req.error);
    });
}






    let accountChart = null; // 🔁 Esto es importante

const monthYear = document.getElementById("month-year");
const calendarDays = document.getElementById("calendar-days");

let currentDate = new Date();
let currentMonth = currentDate.getMonth();
let currentYear = currentDate.getFullYear();

// 🧠 Obtener el número de calendario desde el nombre de la URL
let calendarId = 1; // Por defecto es index.html = Calendario 1
const match = window.location.pathname.match(/calendario(\d+)\.html$/);
if (match) {
    calendarId = parseInt(match[1]);
}



function getStorageKey(month, year) {
        return `calendarData-${calendarId}-${month}-${year}`;
    }

function saveData(month, year, data) {
        localStorage.setItem(getStorageKey(month, year), JSON.stringify(data));
    }

function loadData(month, year) {
        return JSON.parse(localStorage.getItem(getStorageKey(month, year))) || {};
    }

function renderCalendar(month, year) {
        calendarDays.innerHTML = "";
        monthYear.innerText = new Date(year, month).toLocaleString("es-ES", { month: "long", year: "numeric" });

        let firstDay = (new Date(year, month, 1).getDay() + 6) % 7;
        let lastDate = new Date(year, month + 1, 0).getDate();
        let savedData = loadData(month, year);

        let weekContainer = document.createElement("div");
        weekContainer.classList.add("week-container");

        for (let i = 0; i < firstDay; i++) {
            let emptyDiv = document.createElement("div");
            emptyDiv.classList.add("empty");
            weekContainer.appendChild(emptyDiv);
        }

        for (let day = 1; day <= lastDate; day++) {
            let dayDiv = document.createElement("div");
            dayDiv.classList.add("day");
            dayDiv.innerHTML = `<b>${day}</b>`;

            if (day === currentDate.getDate() && month === currentDate.getMonth() && year === currentDate.getFullYear()) {
                dayDiv.classList.add("today");
            }

            let selectContainer = document.createElement("div");
            selectContainer.classList.add("select-container");

            let newButton = document.createElement("button");
            newButton.textContent = "Nuevo";
            newButton.classList.add("new-button");
            newButton.onclick = function () {
                let pair = addSelectPair(selectContainer, month, year, day);
                saveDaySelections(month, year, day, selectContainer);
                updateTotalRatio(selectContainer, month, year, day);
                updateWeeklyTotals(month, year);
            };

            dayDiv.appendChild(selectContainer);
            dayDiv.appendChild(newButton);
            weekContainer.appendChild(dayDiv);

            if (savedData[day]) {
                savedData[day].forEach(pair => {
                    addSelectPair(selectContainer, month, year, day, pair);
                });
            }

            updateTotalRatio(selectContainer, month, year, day);

            if ((new Date(year, month, day).getDay() === 0) || (day === lastDate)) {
                while (weekContainer.children.length < 7) {
                    let emptyDiv = document.createElement("div");
                    emptyDiv.classList.add("empty");
                    weekContainer.appendChild(emptyDiv);
                }

                

                calendarDays.appendChild(weekContainer);
                weekContainer = document.createElement("div");
                weekContainer.classList.add("week-container");
            }
        }

        updateWeeklyTotals(month, year);
    }


function addSelectPair(container, month, year, day, savedValues = { asset: "", ratio: "", image: "", type: "" }) {
    let pairContainer = document.createElement("div");
    pairContainer.classList.add("pair-container");
    pairContainer.savedValues = savedValues; // ✅ Agregado

    

    let assetSelect = document.createElement("select");
    ["", "NAS100", "US30", "SP500", "GBPUSD", "USJPY", "EURUSD", "XAUUSD", "Eliminar"].forEach(asset => {
        let option = document.createElement("option");
        option.value = asset;
        option.textContent = asset || "-- Seleccionar --";
        if (!asset) option.disabled = true;
        if (asset === savedValues.asset) option.selected = true;
        assetSelect.appendChild(option);
    });
    /*Para crear el modal de comentarios*/
    // Crear botón de Comentario
let commentButton = document.createElement("button");
commentButton.textContent = "Comentario 📝";
commentButton.classList.add("comment-button");

let commentIcon = document.createElement("span");
commentIcon.textContent = "💬";
commentIcon.style.display = savedValues.comment ? "inline" : "none";
commentIcon.style.marginLeft = "5px";

commentButton.appendChild(commentIcon);

commentButton.onclick = () => {
    openCommentModal(savedValues.comment || "", (newComment) => {
        savedValues.comment = newComment;
        if (newComment.trim()) {
            commentIcon.style.display = "inline";
        } else {
            commentIcon.style.display = "none";
        }
        saveDaySelections(month, year, day, container);
    });
};


    

    let imageButton = document.createElement("button");
    imageButton.textContent = "Añadir Imagen";
    imageButton.classList.add("image-button");

    let imageInput = document.createElement("input");
    imageInput.type = "file";
    imageInput.accept = "image/*";
    imageInput.style.display = "none";

    let imagePreview = document.createElement("img");
    imagePreview.classList.add("image-preview");
    imagePreview.style.display = "none";

    if (savedValues.image) {
        console.log("🧠 Intentando cargar imagen con ID:", savedValues.image); // 👈 Este es el ID guardado
        (async () => {
            const base64 = await loadImageFromDB(savedValues.image);
            if (typeof base64 === "string" && base64.startsWith("data:image")) {
                console.log("✅ Imagen encontrada:", base64.substring(0, 50));
                imagePreview.src = base64;
                imagePreview.style.display = "block";
            } else {
                console.warn("❌ No se encontró imagen válida con ese ID en IndexedDB");
                imagePreview.style.display = "none";
            }


        })();
        pairContainer.dataset.imageId = savedValues.image;
    }




    imageButton.onclick = () => imageInput.click();

    imageInput.onchange = function () {
        const file = imageInput.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = async function (e) {
                const base64Image = e.target.result;

                const imageId = `img-${calendarId}-${year}-${month}-${day}-${Date.now()}`;
                await saveImageToDB(imageId, base64Image);

                imagePreview.src = base64Image;
                imagePreview.style.display = "block";

                pairContainer.dataset.imageId = imageId;
                saveDaySelections(month, year, day, container);
            };
            reader.readAsDataURL(file);
        }
    };

    imagePreview.onclick = function () {
        openImageModal(imagePreview.src);
    };

    let buttonContainer = document.createElement("div");
    buttonContainer.classList.add("button-container");

    let buyButton = document.createElement("button");
    buyButton.textContent = "Compra";
    buyButton.classList.add("buy-button");

    let sellButton = document.createElement("button");
    sellButton.textContent = "Venta";
    sellButton.classList.add("sell-button");

    if (savedValues.type === "Compra") {
        buyButton.classList.add("selected");
    } else if (savedValues.type === "Venta") {
        sellButton.classList.add("selected");
    }

    let tradeTypeContainer = document.createElement("div");
    tradeTypeContainer.classList.add("trade-type-container");

    let tpButton = document.createElement("button");
    tpButton.textContent = "TP";
    tpButton.classList.add("tp-button");

    let slButton = document.createElement("button");
    slButton.textContent = "SL";
    slButton.classList.add("sl-button");

    let beButton = document.createElement("button");
    beButton.textContent = "BE";
    beButton.classList.add("be-button");

    if (savedValues.trade === "TP") tpButton.classList.add("selected");
    else if (savedValues.trade === "SL") slButton.classList.add("selected");
    else if (savedValues.trade === "BE") beButton.classList.add("selected");

    

    function selectTradeOption(type) {
        tpButton.classList.remove("selected");
        slButton.classList.remove("selected");
        beButton.classList.remove("selected");

        if (type === "TP") tpButton.classList.add("selected");
        else if (type === "SL") slButton.classList.add("selected");
        else if (type === "BE") beButton.classList.add("selected");

        savedValues.trade = type;
        saveDaySelections(month, year, day, container);
    }

    tpButton.onclick = () => selectTradeOption("TP");
    slButton.onclick = () => selectTradeOption("SL");
    beButton.onclick = () => selectTradeOption("BE");

    tradeTypeContainer.appendChild(tpButton);
    tradeTypeContainer.appendChild(slButton);
    tradeTypeContainer.appendChild(beButton);

    function selectType(type) {
        if (type === "Compra") {
            buyButton.classList.add("selected");
            sellButton.classList.remove("selected");
        } else if (type === "Venta") {
            sellButton.classList.add("selected");
            buyButton.classList.remove("selected");
        }
        savedValues.type = type;
        saveDaySelections(month, year, day, container);
    }

    buyButton.onclick = () => selectType("Compra");
    sellButton.onclick = () => selectType("Venta");

    buttonContainer.appendChild(buyButton);
    buttonContainer.appendChild(sellButton);

    assetSelect.onchange = () => {
        if (assetSelect.value === "Eliminar") {
            container.removeChild(pairContainer);
            saveDaySelections(month, year, day, container);
        } else {
            saveDaySelections(month, year, day, container);
        }
        updateTotalRatio(container, month, year, day);
    };

    

    pairContainer.appendChild(assetSelect);
    pairContainer.appendChild(imageButton);
    pairContainer.appendChild(imageInput);
    pairContainer.appendChild(imagePreview);
    pairContainer.appendChild(buttonContainer);
    pairContainer.appendChild(tradeTypeContainer);
    container.appendChild(pairContainer);

    //Botones de emociones
    // Crear contenedor de emociones
let emotionContainer = document.createElement("div");
emotionContainer.style.justifyContent = "center";
emotionContainer.style.gap = "5px";
emotionContainer.style.marginTop = "5px";

// Lista de emojis
const emotions = ["😄", "🙂", "😐", "😞", "😡"];
emotions.forEach((emoji, index) => {
    const span = document.createElement("span");
    span.textContent = emoji;
    span.style.cursor = "pointer";
    span.style.fontSize = "20px";
    span.title = `Estado emocional ${index + 1}`;
    span.dataset.value = index + 1;
    if (savedValues.emotion == index + 1) {
        span.style.border = "2px solid black";
        span.style.borderRadius = "5px";
    }

    span.onclick = () => {
        [...emotionContainer.children].forEach(e => {
            e.style.border = "none";
            e.style.borderRadius = "0";
        });
        span.style.border = "2px solid black";
        span.style.borderRadius = "5px";
        savedValues.emotion = index + 1;
        saveDaySelections(month, year, day, container);
    };

    emotionContainer.appendChild(span);
});
    pairContainer.appendChild(emotionContainer);


    pairContainer.appendChild(commentButton);


    updateTotalRatio(container, month, year, day);
}



function saveDaySelections(month, year, day, container) {
    let selections = [...container.children].map(pair => ({
        asset: pair.children[0].value,
        comment: pair.savedValues?.comment || "",
        image: pair.dataset.imageId || "",
        type: pair.querySelector(".buy-button.selected, .sell-button.selected")?.textContent || "",
        trade: pair.querySelector(".tp-button.selected, .sl-button.selected, .be-button.selected")?.textContent || "",
        emotion: pair.savedValues?.emotion || null
    })).filter(pair => pair.asset !== "Eliminar");

    let data = loadData(month, year);

    if (selections.length > 0) {
        data[day] = selections;
    } else {
        delete data[day];
    }

    saveData(month, year, data);

    // 🔁 Después de guardar, limpiar imágenes huérfanas
    limpiarImagenesHuerfanas();
}

async function limpiarImagenesHuerfanas() {
    const db = await openDB();
    const tx = db.transaction("imagenes", "readonly");
    const store = tx.objectStore("imagenes");

    const allKeys = await new Promise((resolve, reject) => {
        const req = store.getAllKeys();
        req.onsuccess = () => resolve(req.result);
        req.onerror = () => reject(req.error);
    });

    const usedImageIds = new Set();
    for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key.startsWith("calendarData-")) {
            const data = JSON.parse(localStorage.getItem(key));
            for (const day in data) {
                data[day].forEach(entry => {
                    if (entry.image) usedImageIds.add(entry.image);
                });
            }
        }
    }

    const txDelete = db.transaction("imagenes", "readwrite");
    const storeDelete = txDelete.objectStore("imagenes");

    let eliminadas = 0;

    allKeys.forEach(id => {
        if (!usedImageIds.has(id)) {
            storeDelete.delete(id);
            eliminadas++;
        }
    });

    if (eliminadas > 0) {
        console.log(`🧹 Imágenes huérfanas eliminadas automáticamente: ${eliminadas}`);
    }
}


function openCommentModal(initialText, onSaveCallback) {
    const modal = document.getElementById("comment-modal");
    const textarea = document.getElementById("comment-text");
    const saveBtn = document.getElementById("save-comment");
    const closeBtn = document.getElementById("close-comment-modal");

    textarea.value = initialText;

    modal.style.display = "flex";

    // Guardar
    saveBtn.onclick = () => {
        const newComment = textarea.value;
        onSaveCallback(newComment);
        modal.style.display = "none";
    };

    // Cerrar sin guardar
    closeBtn.onclick = () => {
        modal.style.display = "none";
    };
}



function openImageModal(imageSrc) {
    let modal = document.createElement("div");
    modal.classList.add("image-modal");
    modal.innerHTML = `
        <div class="modal-content">
            <span class="close-modal">&times;</span>
            <img src="${imageSrc}" class="modal-image">
        </div>
    `;

    document.body.appendChild(modal);

    document.body.classList.add("hide-header");

    modal.querySelector(".close-modal").onclick = function () {
        document.body.removeChild(modal);
        document.body.classList.remove("hide-header");
    };
}

function updateTotalRatio(container, month, year, day) {
    // Solo dejar algún texto simple o nada
    let totalElement = container.parentElement.querySelector(".total-ratio");
    if (!totalElement) {
        totalElement = document.createElement("div");
        totalElement.classList.add("total-ratio");
        container.parentElement.appendChild(totalElement);
    }

    totalElement.textContent = ""; // o mostrar "comentario agregado"
}




function changeMonth(step) {
    currentMonth += step;
    renderCalendar(currentMonth, currentYear);
}

renderCalendar(currentMonth, currentYear);






//modal de Premios
// Modal de Premios




</script>
</main>





</body>



<!-- Modal para detalles -->

<!-- Modal de Comentario -->
<div id="comment-modal" class="modal" style="display: none;">
  <div class="modal-content">
    <span class="close-modal" id="close-comment-modal">&times;</span>
    <h3>Comentario</h3>
    <textarea id="comment-text" rows="6" style="width: 100%; font-size: 14px; padding: 8px; border-radius: 5px;"></textarea>
    <button id="save-comment" style="margin-top: 10px; padding: 6px 12px; font-weight: bold;">Guardar</button>
  </div>
</div>

<!-- Modal de Premios -->
<div id="rewards-modal" class="modal" style="display: none;">
  <div class="modal-content">
    <span class="close-modal" id="close-rewards-modal">&times;</span>
    <h3>🎁 Premios</h3>
    <div style="text-align: center; margin-bottom: 15px;">
        <button id="get-reward-btn" class="details-button">🎁 Recibir mi premio</button>
    </div>

    <p>Aquí aparecerán tus recompensas basadas en emociones y logros.</p>
    <!-- Aquí puedes insertar lógica o recompensas más adelante -->
     <div id="emotion-summary" style="margin-top: 20px;">
        <h4 style="text-align: center;">Resumen emocional por semana</h4>
        <div id="emotion-thermometers" style="display: flex; gap: 20px; justify-content: center;"></div>
    </div>


  </div>
</div>
<script>

//boton recibir regalo


document.addEventListener("DOMContentLoaded", () => {
  const openBtn = document.getElementById("open-rewards");
  const closeBtn = document.getElementById("close-rewards-modal");
  const modal = document.getElementById("rewards-modal");

/////////////////
document.getElementById("get-reward-btn").onclick = () => {
  const data = loadData(currentMonth, currentYear);
  const hoy = new Date();

  const primerDia = new Date(currentYear, currentMonth, 1);
  const diaSemana1 = primerDia.getDay() === 0 ? 7 : primerDia.getDay();
  const primerLunes = new Date(currentYear, currentMonth, 1 - (diaSemana1 - 1));
  const diasDesdePrimerLunes = Math.floor((hoy - primerLunes) / (1000 * 60 * 60 * 24));
  const semanaActual = Math.floor(diasDesdePrimerLunes / 7);

  const emocionesSemana = [];

  for (let d in data) {
    const fecha = new Date(currentYear, currentMonth, parseInt(d));
    const diasDesde = Math.floor((fecha - primerLunes) / (1000 * 60 * 60 * 24));
    const semana = Math.floor(diasDesde / 7);

    if (semana === semanaActual) {
      data[d].forEach(e => {
        if (e.emotion) emocionesSemana.push(parseInt(e.emotion));
      });
    }
  }

  if (emocionesSemana.length === 0) {
    alert("No tienes emociones registradas esta semana. 😶");
    return;
  }

  const suma = emocionesSemana.reduce((a, b) => a + b, 0);
  const promedio = suma / emocionesSemana.length;
  const nivelRedondeado = Math.round(promedio);
  const EMOJIS = ["😄", "🙂", "😐", "😞", "😡"];

  // 🎁 Mensajes por tipo
  const premios = [
    "Te ganaste una noche libre para ti.",
    "Busca placer... sin excusas. 😉",
    "Cómprate ese gustito que estabas evitando.",
    "Pide delivery. Hoy no cocinas.",
    "Un día sin alarma. Te lo mereces.",
    "Playlist sensual y a disfrutar el momento.",
    "Haz match y responde sin miedo hoy.",
    "Mereces una sesión de spa casera.",
    "Haz solo lo que te dé la gana por 2h.",
    "Rómpete la dieta. Hoy sí vale."
  ];

  const castigos = [
    "No operes mañana. Estás emocionalmente inestable.",
    "Nada de redes sociales por 24h.",
    "No gaseosa ni dulces por 3 días.",
    "Haz 1h de cardio. Ni 59 minutos.",
    "Cero contacto humano innecesario.",
    "No puedes usar emojis por 1 día.",
    "Limpia tu espacio completo antes de operar.",
    "No Netflix hoy. Solo leer o dormir.",
    "Desinstala TikTok por 48h.",
    "Haz una tarea que has estado evitando. Hoy."
  ];

  const neutros = [
    "Tu semana fue estable. Mantené el ritmo.",
    "Buen balance emocional. Nada que castigar ni premiar.",
    "No hagas nada distinto. Solo seguí igual.",
    "Puedes operar hoy, pero sin exceso de confianza.",
    "Semana estable. Celebralo en silencio."
  ];

  let mensajeFinal = "";

  if (nivelRedondeado <= 2) {
    const premio = premios[Math.floor(Math.random() * premios.length)];
    mensajeFinal = `🎁 Premio para ti:\n${premio}`;
  } else if (nivelRedondeado >= 4) {
    const castigo = castigos[Math.floor(Math.random() * castigos.length)];
    mensajeFinal = `⚠️ Castigo de la semana:\n${castigo}`;
  } else {
    const neutral = neutros[Math.floor(Math.random() * neutros.length)];
    mensajeFinal = `😌 Estado emocional moderado:\n${neutral}`;
  }

  alert(`Semana actual → Nivel emocional: ${nivelRedondeado} ${EMOJIS[nivelRedondeado - 1]}\n\n${mensajeFinal}`);
};

/////////////////


  if (openBtn && modal && closeBtn) {
        openBtn.addEventListener("click", () => {
        modal.style.display = "flex";
        calcularResumenEmocionalSemanal(); // 🧠 nueva función
    });


    closeBtn.addEventListener("click", () => {
      modal.style.display = "none";
    });
  } else {
    console.error("No se encontraron elementos del modal de premios.");
  }
});


function calcularResumenEmocionalSemanal() {
  const data = loadData(currentMonth, currentYear);
  const semanas = {};

  for (let day in data) {
    const fecha = new Date(currentYear, currentMonth, parseInt(day));
    // Calcular número de semana basado en el primer lunes del mes
    // Semana basada en lunes a domingo
    const primerDia = new Date(currentYear, currentMonth, 1);
    const diaSemana1 = primerDia.getDay() === 0 ? 7 : primerDia.getDay(); // domingo = 7
    const primerLunes = new Date(currentYear, currentMonth, 1 - (diaSemana1 - 1)); // retroceder al lunes más cercano

    const diasDesdePrimerLunes = Math.floor((fecha - primerLunes) / (1000 * 60 * 60 * 24));
    const semanaIndex = Math.floor(diasDesdePrimerLunes / 7);

    if (!semanas[semanaIndex]) semanas[semanaIndex] = [];

    data[day].forEach(entry => {
      if (entry.emotion) {
        semanas[semanaIndex].push(parseInt(entry.emotion));
      }
    });
  }

  const container = document.getElementById("emotion-thermometers");
  container.innerHTML = ""; // Limpiar

  const EMOJIS = ["😄", "🙂", "😐", "😞", "😡"];
//const EMOJIS = ["😡", "😞", "😐", "🙂", "😄"];


  for (let semana in semanas) {
    const emociones = semanas[semana];
    if (emociones.length === 0) continue;

    const suma = emociones.reduce((a, b) => a + b, 0);
    const promedio = suma / emociones.length;

    const columna = document.createElement("div");
    columna.style.display = "flex";
    columna.style.flexDirection = "column-reverse";
    columna.style.alignItems = "center";
    columna.style.justifyContent = "flex-end";
    columna.style.height = "160px";
    columna.style.width = "60px";
    columna.style.borderLeft = "2px solid #999";
    columna.style.position = "relative";

    for (let i = 5; i >= 1; i--) {
      const emoji = document.createElement("div");
      emoji.textContent = EMOJIS[i - 1];
      emoji.style.height = "30px";
      emoji.style.fontSize = "20px";
const nivelRedondeado = Math.round(promedio); // nivel 1 a 5
const nivelActual = i; // del 5 al 1 en el bucle

if (nivelActual === nivelRedondeado) {
    emoji.style.opacity = "1";
    emoji.style.fontWeight = "bold";
    emoji.style.color = "#e67e22";
    emoji.style.textShadow = "0 0 5px rgba(255,165,0,0.6)";
    emoji.style.transform = "scale(1.3)";
} else {
    emoji.style.opacity = "0.3";
}
      columna.appendChild(emoji);
    }

    // Título
    const etiqueta = document.createElement("div");
    etiqueta.textContent = `Semana ${parseInt(semana) + 1}`;
    etiqueta.style.marginTop = "5px";
    etiqueta.style.fontWeight = "bold";
    etiqueta.style.textAlign = "center";

    const bloque = document.createElement("div");
    bloque.style.display = "flex";
    bloque.style.flexDirection = "column";
    bloque.style.alignItems = "center";
    bloque.appendChild(columna);
    bloque.appendChild(etiqueta);

    container.appendChild(bloque);
  }
  // === RESUMEN MENSUAL ===
let todasLasEmociones = [];
Object.values(semanas).forEach(lista => todasLasEmociones.push(...lista));

if (todasLasEmociones.length > 0) {
    const sumaMes = todasLasEmociones.reduce((a, b) => a + b, 0);
    const promedioMes = sumaMes / todasLasEmociones.length;
    const nivelRedondeado = Math.round(promedioMes); // nivel 1 a 5

    const columna = document.createElement("div");
    columna.style.display = "flex";
    columna.style.flexDirection = "column-reverse";
    columna.style.alignItems = "center";
    columna.style.justifyContent = "flex-end";
    columna.style.height = "160px";
    columna.style.width = "60px";
    columna.style.borderLeft = "2px solid #999";
    columna.style.position = "relative";

    const EMOJIS = ["😄", "🙂", "😐", "😞", "😡"];
    for (let i = 5; i >= 1; i--) {
        const emoji = document.createElement("div");
        emoji.textContent = EMOJIS[i - 1];
        emoji.style.height = "30px";
        emoji.style.fontSize = "20px";

        if (i === nivelRedondeado) {
            emoji.style.opacity = "1";
            emoji.style.fontWeight = "bold";
            emoji.style.color = "#e74c3c";
            emoji.style.textShadow = "0 0 6px rgba(231, 76, 60, 0.6)";
            emoji.style.transform = "scale(1.4)";
        } else {
            emoji.style.opacity = "0.3";
        }

        columna.appendChild(emoji);
    }

    const etiqueta = document.createElement("div");
    etiqueta.textContent = `Resumen del mes → ${EMOJIS[nivelRedondeado - 1]}`;

    // 🎁 Premios y castigos por nivel emocional

    etiqueta.style.marginTop = "5px";
    etiqueta.style.fontWeight = "bold";
    etiqueta.style.textAlign = "center";

    const bloque = document.createElement("div");
    bloque.style.display = "flex";
    bloque.style.flexDirection = "column";
    bloque.style.alignItems = "center";
    bloque.style.marginLeft = "30px";
    bloque.appendChild(columna);
    bloque.appendChild(etiqueta);

    container.appendChild(bloque);
}

}

</script>








</html>
